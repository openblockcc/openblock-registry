#!/usr/bin/env node

/**
 * Generate TOOLCHAINS.md from R2 packages.json
 * This script fetches the packages.json from R2 and generates a markdown table
 * showing the availability of toolchains across different platforms.
 */

import fs from 'fs';
import path from 'path';
import {fileURLToPath} from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const PACKAGES_JSON_URL = 'https://registry.openblock.cc/packages.json';
const OUTPUT_FILE = path.join(__dirname, '..', 'TOOLCHAINS.md');

// Platform order for table columns
const PLATFORMS = [
    'win32-x64',
    'darwin-x64',
    'darwin-arm64',
    'linux-x64',
    'linux-arm64',
    'linux-arm'
];

/**
 * Fetch packages.json from R2
 * @returns {Promise<object>} The packages.json data
 */
const fetchPackagesJson = async function () {
    const response = await fetch(PACKAGES_JSON_URL);
    if (!response.ok) {
        throw new Error(`Failed to fetch packages.json: ${response.status} ${response.statusText}`);
    }
    return response.json();
};

/**
 * Generate markdown table row for a toolchain
 * @param {object} toolchain - The toolchain object
 * @returns {string} The markdown table row
 */
const generateTableRow = function (toolchain) {
    const availableHosts = new Set(toolchain.systems.map(s => s.host));
    const cells = PLATFORMS.map(platform => availableHosts.has(platform) ? 'âœ“' : '');
    return `| ${toolchain.id} | ${toolchain.version} | ${cells.join(' | ')} |`;
};

/**
 * Generate the complete TOOLCHAINS.md content
 * @param {Array} toolchains - Array of toolchain objects
 * @returns {string} The complete markdown content
 */
const generateMarkdown = function (toolchains) {
    const header = `# Available Toolchains

> This file is auto-generated by the \`sync-arduino-toolchains\` GitHub Action. Do not edit manually.

## Current State

| Toolchain | Version | ${PLATFORMS.join(' | ')} |
| --------- | ------- | ${PLATFORMS.map(() => ':-------:').join(' | ')} |`;

    const rows = toolchains
        .sort((a, b) => a.id.localeCompare(b.id))
        .map(generateTableRow)
        .join('\n');

    return `${header}\n${rows}\n`;
};

/**
 * Main function
 * @returns {Promise<void>} Promise that resolves when complete
 */
const main = async function () {
    console.log('Fetching packages.json from R2...');

    try {
        const packagesJson = await fetchPackagesJson();
        const toolchains = packagesJson.packages?.toolchains || [];

        if (toolchains.length === 0) {
            console.warn('No toolchains found in packages.json');
            return;
        }

        console.log(`Found ${toolchains.length} toolchains`);

        const markdown = generateMarkdown(toolchains);
        fs.writeFileSync(OUTPUT_FILE, markdown);

        console.log(`Generated ${OUTPUT_FILE}`);
    } catch (error) {
        console.error('Error:', error.message);
        process.exit(1);
    }
};

main();
